var IdoShare = (function(){
  if(typeof window.console === 'undefined'){
    window.console = {log: function(){return false;}};
  }

/*
* TODO Dependency loading, JSON
* TODO mixpanel old async library?
*
*/
  var auth_token = '<%= @auth_token.token  %>'
      ,endpoint_url = '<%= events_url %>.json'
      ;  


  function push(event_array){
      console.log("pushing event", event_array);
      var tag = document.createElement("script");
      tag.type = "text/javascript"; 
      tag.async = true;
      tag.defer = true;
      tag.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + endpoint_url+"?umi_token="+auth_token+"&event="+encodeURIComponent(JSON.stringify(event_array));
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(tag, s);
  }


  
  function checkForGA(){
    if(typeof window._gaq == 'undefined'){
	return false;
    }

    if(window._gaq.push != [].push){
	console.log("updating the push method");
	var old_meth = window._gaq.push
	window._gaq.push = function(){
	    var ido_event = {
		category: arguments[0][1]
		,name: arguments[0][2]
		,data : {
		    label: arguments[0][3]
		    ,value: arguments[0][4]
		}
	    };
	    push(ido_event);
	    old_meth.apply(window._gaq, arguments);
	}
    }
  }


  function checkForMP(){
    var mp_api, old_meth;

    if(typeof window.mpq != 'undefined'){
	mp_api = window.mpq
    }else if(typeof window.mixpanel != 'undefined'){
	mp_api = window.mixpanel
    }else{
	return false;
    }

    if(typeof mp_api.track != 'undefined'){
	var old_meth = mp_api.track;
	mp_api.track = function(){
	    var ido_event = {
		category: "WebMetric"
		,name: arguments[0]
		,data : arguments[1]
	    };
	    push(ido_event);
	    old_meth.apply(window.mixpanel, arguments);
        }
    }

  }

  checkForGA();
  checkForMP();

  return {
      push: push
  };

})();
